{"version":3,"sources":["../../src/methods/remove.ts"],"sourcesContent":["import { runMultipleHook, runSingleHook } from '../components/hooks.js'\nimport {\n  DocumentID,\n  getDocumentIdFromInternalId,\n  getInternalDocumentId,\n} from '../components/internal-document-id-store.js'\nimport { trackRemoval } from '../components/sync-blocking-checker.js'\nimport { AnyOrama } from '../types.js'\n\nexport async function remove<T extends AnyOrama>(orama: T, id: DocumentID, language?: string, skipHooks?: boolean): Promise<boolean> {\n  let result = true\n  const { index, docs } = orama.data\n\n  const doc = await orama.documentsStore.get(docs, id)\n  if (!doc) {\n    return false\n  }\n\n  const docId = getDocumentIdFromInternalId(\n    orama.internalDocumentIDStore,\n    getInternalDocumentId(orama.internalDocumentIDStore, id),\n  )\n  const docsCount = await orama.documentsStore.count(docs)\n\n  if (!skipHooks) {\n    await runSingleHook(orama.beforeRemove, orama, docId)\n  }\n\n  const indexableProperties = await orama.index.getSearchableProperties(index)\n  const indexablePropertiesWithTypes = await orama.index.getSearchablePropertiesWithTypes(index)\n  const values = await orama.getDocumentProperties(doc, indexableProperties)\n\n  for (const prop of indexableProperties) {\n    const value = values[prop]\n    // The document doesn't contain the key\n    if (typeof value === 'undefined') {\n      continue\n    }\n\n    const schemaType = indexablePropertiesWithTypes[prop]\n\n    await orama.index.beforeRemove?.(\n      orama.data.index,\n      prop,\n      docId,\n      value,\n      schemaType,\n      language,\n      orama.tokenizer,\n      docsCount,\n    )\n    if (\n      !(await orama.index.remove(\n        orama.index,\n        orama.data.index,\n        prop,\n        id,\n        value,\n        schemaType,\n        language,\n        orama.tokenizer,\n        docsCount,\n      ))\n    ) {\n      result = false\n    }\n    await orama.index.afterRemove?.(\n      orama.data.index,\n      prop,\n      docId,\n      value,\n      schemaType,\n      language,\n      orama.tokenizer,\n      docsCount,\n    )\n  }\n\n  const sortableProperties = await orama.sorter.getSortableProperties(orama.data.sorting)\n  const sortableValues = await orama.getDocumentProperties(doc, sortableProperties)\n  for (const prop of sortableProperties) {\n    // The document doesn't contain the key\n    if (typeof sortableValues[prop] === 'undefined') {\n      continue\n    }\n\n    await orama.sorter.remove(orama.data.sorting, prop, id)\n  }\n\n  if (!skipHooks) {\n    await runSingleHook(orama.afterRemove, orama, docId)\n  }\n\n  await orama.documentsStore.remove(orama.data.docs, id)\n\n  trackRemoval(orama)\n  return result\n}\n\nexport async function removeMultiple<T extends AnyOrama>(\n  orama: T,\n  ids: DocumentID[],\n  batchSize?: number,\n  language?: string,\n  skipHooks?: boolean,\n): Promise<number> {\n  let result = 0\n\n  if (!batchSize) {\n    batchSize = 1000\n  }\n\n  const docIdsForHooks = skipHooks\n    ? []\n    : ids.map(id =>\n        getDocumentIdFromInternalId(\n          orama.internalDocumentIDStore,\n          getInternalDocumentId(orama.internalDocumentIDStore, id),\n        ),\n      )\n\n  if (!skipHooks) {\n    await runMultipleHook(orama.beforeMultipleRemove, orama, docIdsForHooks)\n  }\n\n  await new Promise<void>((resolve, reject) => {\n    let i = 0\n    async function _insertMultiple() {\n      const batch = ids.slice(i * batchSize!, (i + 1) * batchSize!)\n      i++\n\n      if (!batch.length) {\n        return resolve()\n      }\n\n      for (const doc of batch) {\n        try {\n          if (await remove(orama, doc, language, skipHooks)) {\n            result++\n          }\n        } catch (err) {\n          reject(err)\n        }\n      }\n\n      setTimeout(_insertMultiple, 0)\n    }\n\n    setTimeout(_insertMultiple, 0)\n  })\n\n  if (!skipHooks) {\n    await runMultipleHook(orama.afterMultipleRemove, orama, docIdsForHooks)\n  }\n\n  return result\n}\n"],"names":["runMultipleHook","runSingleHook","getDocumentIdFromInternalId","getInternalDocumentId","trackRemoval","remove","orama","id","language","skipHooks","result","index","docs","data","doc","documentsStore","get","docId","internalDocumentIDStore","docsCount","count","beforeRemove","indexableProperties","getSearchableProperties","indexablePropertiesWithTypes","getSearchablePropertiesWithTypes","values","getDocumentProperties","prop","value","schemaType","tokenizer","afterRemove","sortableProperties","sorter","getSortableProperties","sorting","sortableValues","removeMultiple","ids","batchSize","docIdsForHooks","map","beforeMultipleRemove","Promise","resolve","reject","i","_insertMultiple","batch","slice","length","err","setTimeout","afterMultipleRemove"],"mappings":"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"}