{"version":3,"sources":["../../src/components/groups.ts"],"sourcesContent":["import { createError } from '../errors.js'\nimport { getNested, intersect, safeArrayPush } from '../utils.js'\nimport type { AnyDocument, AnyOrama, GroupByParams, GroupResult, Reduce, Result, ScalarSearchableValue, TokenScore, TypedDocument } from '../types.js'\nimport { getDocumentIdFromInternalId } from './internal-document-id-store.js'\n\ninterface PropertyGroup {\n  property: string\n  perValue: Record<\n    string,\n    {\n      indexes: number[]\n      count: number\n    }\n  >\n}\n\ninterface Group {\n  values: ScalarSearchableValue[]\n  indexes: number[]\n}\n\nconst DEFAULT_REDUCE: Reduce<Result<AnyDocument>[]> = {\n  reducer: (_, acc, res, index) => {\n    acc[index] = res\n    return acc\n  },\n  getInitialValue: length => Array.from({ length }),\n}\n\nconst ALLOWED_TYPES = ['string', 'number', 'boolean']\n\nexport async function getGroups<T extends AnyOrama, ResultDocument = TypedDocument<T>>(\n  orama: T,\n  results: TokenScore[],\n  groupBy: GroupByParams<T, ResultDocument>,\n): Promise<GroupResult<ResultDocument>> {\n  const properties = groupBy.properties\n  const propertiesLength = properties.length\n\n  const schemaProperties = await orama.index.getSearchablePropertiesWithTypes(orama.data.index)\n  for (let i = 0; i < propertiesLength; i++) {\n    const property = properties[i]\n    if (typeof schemaProperties[property] === 'undefined') {\n      throw createError('UNKNOWN_GROUP_BY_PROPERTY', property)\n    }\n    if (!ALLOWED_TYPES.includes(schemaProperties[property])) {\n      throw createError('INVALID_GROUP_BY_PROPERTY', property, ALLOWED_TYPES.join(', '), schemaProperties[property])\n    }\n  }\n\n  const allIDs = results.map(([id]) => getDocumentIdFromInternalId(orama.internalDocumentIDStore, id))\n\n  // allDocs is already sorted by the sortBy algorithm\n  // We leverage on that to limit the number of documents returned\n  const allDocs = await orama.documentsStore.getMultiple(orama.data.docs, allIDs)\n  const allDocsLength = allDocs.length\n\n  const returnedCount = groupBy.maxResult || Number.MAX_SAFE_INTEGER\n\n  const listOfValues: ScalarSearchableValue[][] = []\n\n  // We want to understand which documents have which values\n  // and group them by the property and values\n  const g: Record<string, PropertyGroup> = {}\n  for (let i = 0; i < propertiesLength; i++) {\n    const groupByKey = properties[i]\n    const group: PropertyGroup = {\n      property: groupByKey,\n      perValue: {},\n    }\n\n    const values: Set<ScalarSearchableValue> = new Set()\n    for (let j = 0; j < allDocsLength; j++) {\n      const doc = allDocs[j]\n\n      const value = await getNested<ScalarSearchableValue>(doc as object, groupByKey)\n      // we don't want to consider undefined values\n      if (typeof value === 'undefined') {\n        continue\n      }\n      const keyValue = typeof value !== 'boolean' ? value : '' + value\n      if (typeof group.perValue[keyValue] === 'undefined') {\n        group.perValue[keyValue] = {\n          indexes: [],\n          count: 0,\n        }\n      }\n      if (group.perValue[keyValue].count >= returnedCount) {\n        // We stop early because for this value we react the limit\n        continue\n      }\n\n      // We use the index to keep track of the original order\n      group.perValue[keyValue].indexes.push(j)\n      group.perValue[keyValue].count++\n\n      values.add(value)\n    }\n\n    listOfValues.push(Array.from(values))\n\n    g[groupByKey] = group\n  }\n\n  const combinations = calculateCombination(listOfValues)\n  const combinationsLength = combinations.length\n\n  const groups: Group[] = []\n  for (let i = 0; i < combinationsLength; i++) {\n    const combination = combinations[i]\n    const combinationLength = combination.length\n\n    const group: Group = {\n      values: [],\n      indexes: [],\n    }\n    const indexes: number[][] = []\n    for (let j = 0; j < combinationLength; j++) {\n      const value = combination[j]\n      const property = properties[j]\n      indexes.push(g[property].perValue[typeof value !== 'boolean' ? value : '' + value].indexes)\n      group.values.push(value)\n    }\n    // We leverage on the index to sort the results by the original order\n    group.indexes = intersect(indexes).sort((a, b) => a - b)\n\n    // don't generate empty groups\n    if (group.indexes.length === 0) {\n      continue\n    }\n\n    groups.push(group)\n  }\n\n  const groupsLength = groups.length\n  const res: GroupResult<ResultDocument> = Array.from({ length: groupsLength })\n  for (let i = 0; i < groupsLength; i++) {\n    const group = groups[i]\n\n    const reduce = (groupBy.reduce || DEFAULT_REDUCE) as Reduce<Result<ResultDocument>[]>\n\n    const docs = group.indexes.map(index => {\n      return {\n        id: allIDs[index],\n        score: results[index][1],\n        document: allDocs[index]!,\n      }\n    })\n\n    const func = reduce.reducer.bind(null, group.values)\n    const initialValue = reduce.getInitialValue(group.indexes.length)\n    const aggregationValue = docs.reduce(func, initialValue)\n\n    res[i] = {\n      values: group.values,\n      result: aggregationValue,\n    }\n  }\n\n  return res\n}\n\nfunction calculateCombination(arrs: ScalarSearchableValue[][], index = 0): ScalarSearchableValue[][] {\n  if (index + 1 === arrs.length) return arrs[index].map(item => [item])\n\n  const head = arrs[index]\n  const c = calculateCombination(arrs, index + 1)\n\n  const combinations: ScalarSearchableValue[][] = []\n  for (const value of head) {\n    for (const combination of c) {\n      const result = [value];\n\n      safeArrayPush(result, combination)\n\n      combinations.push(result)\n    }\n  }\n\n  return combinations\n}\n"],"names":["createError","getNested","intersect","safeArrayPush","getDocumentIdFromInternalId","DEFAULT_REDUCE","reducer","_","acc","res","index","getInitialValue","length","Array","from","ALLOWED_TYPES","getGroups","orama","results","groupBy","properties","propertiesLength","schemaProperties","getSearchablePropertiesWithTypes","data","i","property","includes","join","allIDs","map","id","internalDocumentIDStore","allDocs","documentsStore","getMultiple","docs","allDocsLength","returnedCount","maxResult","Number","MAX_SAFE_INTEGER","listOfValues","g","groupByKey","group","perValue","values","Set","j","doc","value","keyValue","indexes","count","push","add","combinations","calculateCombination","combinationsLength","groups","combination","combinationLength","sort","a","b","groupsLength","reduce","score","document","func","bind","initialValue","aggregationValue","result","arrs","item","head","c"],"mappings":"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"}